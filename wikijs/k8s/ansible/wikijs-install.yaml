---
- name: "Install Wiki.js - {{ app_version }}"
  hosts: "{{ k8s_host | default('localhost') }}"
  gather_facts: "{{ gathering_host_info | default('true') | bool == true }}"

  pre_tasks:
    - name: "Validate variables"
      assert:
        that:
          # - "pv_root_folder is defined"
          - "app_name is defined"
          - "app_namespace is defined"
          - "db_password is defined"
        fail_msg: "Missing required parameters"

  tasks:
    - name: "Template Wiki.js deployment files"
      ansible.builtin.template:
        src: "helm-wikijs-values.yaml.j2"
        dest: "/tmp/helm-wikijs-values.yaml"
        mode: '0600'

    - name: "Create Wiki.js secret with postgresql password"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          type: Opaque
          metadata:
            namespace: "{{ app_namespace }}"
            name: "wikijs"
            labels:
              app.kubernetes.io/name: "{{ app_name }}"
              app.kubernetes.io/version: "{{ app_version }}"
          data:
            postgresql-password: "{{ db_password | b64encode }}"
  
    - name: "Deploy Wiki.js with Helm"
      kubernetes.core.helm:
        name: "{{ app_name }}"
        chart_ref: "requarks/wiki"
        release_namespace: "{{ app_namespace }}"
        wait: true
        replace: false
        values_files:
          - /tmp/helm-wikijs-values.yaml
      register: odoo_helm_res 
...
