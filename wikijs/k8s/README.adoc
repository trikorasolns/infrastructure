= Wiki.js on Kubernetes
:author:    Antonio C.
:email:     <ac (at) trikorasolutions (dot) com>
:Revision:  1
:toc:       left
:toc-title: Table of Contents
:icons: font
:source-highlighter: highlight.js


== Installation

[.lead]
Installation instructions.

Create the namespace.

[source,bash]
----
ansible-playbook wikijs/k8s/ansible/wikijs-prepare.yaml \
  -e "@wikijs/k8s/config/app.yaml"
----

Deploy PostgreSQL.

[source,bash]
----
ansible-playbook pgsql/k8s/helm/ansible/pgsql-install-playbook.yaml \
  -e "@kubernetes/storage/ceph/ansible/defaults/main.yaml" \
  -e "@wikijs/k8s/config/app.yaml" \
  -e db_password=${DB_PASSWORD}
----

Deploy Wiki.js.

[source,bash]
----
ansible-playbook wikijs/k8s/ansible/wikijs-install.yaml \
  -e "@_local_config/network.yaml" \
  -e "@wikijs/k8s/config/app.yaml" \
  -e db_password=${DB_PASSWORD} 
----
== Uninstall

[source,bash]
----
ansible-playbook wikijs/k8s/ansible/wikijs-uninstall.yaml \
  -e "@wikijs/k8s/config/app.yaml"
----

[source,bash]
----
podman pod rm wiki.js 
----

== Backup

[source,bash]
----
BACKUP_FILE_NAME=$(date +%Y-%m-%d-%H-%M-%S)_wikibackup.dump
----

Bash into de PostgreSQL POD.

[source,bash]
----
kubectl -n wikijs exec -it postgresql-0 -- env BACKUP_FILE_NAME=${BACKUP_FILE_NAME} /bin/bash
kubectl -n wikijs exec -it postgresql-0 -- bash
----

[source,bash]
----
pg_dump wikijs -U wikijs -F c > /tmp/${BACKUP_FILE_NAME}
----

[source,bash]
----
kubectl -n wikijs cp wikijs/postgresql-0:/tmp/${BACKUP_FILE_NAME} ${BACKUP_ROOT_FOLDER}/wikijs/${BACKUP_FILE_NAME}
----

== Restore