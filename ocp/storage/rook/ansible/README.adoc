= Rook on OpenShift
Antonio C. <ac (at) trikorasolutions (dot) com>
:revdate: {docdate}
:icons: font
:toc: left
:toclevels: 3
:toc-title: Table of Contents
:description: Rook on OpenShift

== Introduction

[.lead]
This document is WIP and describes the deployment of the OpenShift Data 
 Foundation operator and a Ceph storage.

== Storage

References:

* https://rook.io/docs/rook/latest-release/Getting-Started/quickstart/#storage

=== Block Storage


[source,bash]
----
oc create -f ocp/storage/rook/ansible/files/rook-ceph-blockstore.yaml
----

* Block Storage: https://rook.io/docs/rook/latest-release/Storage-Configuration/Block-Storage-RBD/block-storage/

=== Shared File System

[source,bash]
----
oc create -f ocp/storage/rook/ansible/files/rook-ceph-filesystem.yaml
----

Shared File System Storage class.

[source,bash]
----
oc create -f ocp/storage/rook/ansible/files/rook-ceph-filesystem-sc.yaml
----


* Shared FS: https://rook.io/docs/rook/latest-release/Storage-Configuration/Shared-Filesystem-CephFS/filesystem-storage/


=== Object Storage

[source,bash]
----
oc create -f ocp/storage/rook/ansible/files/rook-ceph-objectstore.yaml
----

* Object Storage: https://rook.io/docs/rook/latest-release/Storage-Configuration/Object-Storage-RGW/object-storage/

== Test

=== Block Storage

[source,bash]
----
oc create -f ocp/storage/rook/ansible/files/test-rook-bs.yaml
----

[source,bash]
----
oc delete -f ocp/storage/rook/ansible/files/test-rook-bs.yaml
----

=== CephFS
To test the configuration execute the following configuration that will deploy 
 an nginx pod with a volume attached to a PVC. The PVC should provision a PV
 automatically.

[source,bash]
----
oc apply -f ocp/storage/rook/ansible/files/test-rook-fs.yaml
----

[source,bash]
----
oc get pvc
----

[source,]
----
NAME                   STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
pvc-rook-cephfs-test   Pending                                      rook-cephfs    11s
----

Delete manila test.

[source,bash]
----
oc delete -f ocp/storage/rook/ansible/files/test-rook-fs.yaml
----
== References

* https://rook.io/docs/rook/latest-release/Getting-Started/ceph-openshift/
* https://rook.io/docs/rook/latest-release/Getting-Started/quickstart/
* Dashboard: https://rook.io/docs/rook/latest-release/Storage-Configuration/Monitoring/ceph-dashboard/
Toolbox: https://rook.io/docs/rook/latest-release/Getting-Started/quickstart/#tools


== Troubleshooting

=== Rook Ceph Operator doesn't deploy any POD

*Problem*

Rook operator ReplicaSet doesn't deploy any POD.

*Symptom*

Several ReplicaSet of the Rook Ceph project are in error state. The error is the following.

[source,bash]
----
oc -n rook-ceph describe rs rook-ceph-operator-746677996c
----

[source,]
----
Events:
  Type     Reason        Age                  From                   Message
  ----     ------        ----                 ----                   -------
  Warning  FailedCreate  85s (x119 over 8h)   replicaset-controller  Error creating: pods "rook-ceph-operator-746677996c-" is forbidden: unable to validate against any security context constraint: [provider "anyuid": Forbidden: not usable by user or serviceaccount, provider "pipelines-scc": Forbidden: not usable by user or serviceaccount, provider "db2u-c-mas-masovh-system-scc": Forbidden: not usable by user or serviceaccount, provider restricted-v2: .containers[0].runAsUser: Invalid value: 2016: must be in the ranges: [1000290000, 1000299999], provider "restricted": Forbidden: not usable by user or serviceaccount, provider "nonroot-v2": Forbidden: not usable by user or serviceaccount, provider "nonroot": Forbidden: not usable by user or serviceaccount, provider "noobaa": Forbidden: not usable by user or serviceaccount, provider "hostmount-anyuid": Forbidden: not usable by user or serviceaccount, provider "machine-api-termination-handler": Forbidden: not usable by user or serviceaccount, provider "hostnetwork-v2": Forbidden: not usable by user or serviceaccount, provider "hostnetwork": Forbidden: not usable by user or serviceaccount, provider "hostaccess": Forbidden: not usable by user or serviceaccount, provider "rook-ceph": Forbidden: not usable by user or serviceaccount, provider "node-exporter": Forbidden: not usable by user or serviceaccount, provider "rook-ceph-csi": Forbidden: not usable by user or serviceaccount, provider "privileged": Forbidden: not usable by user or serviceaccount]
----

*Cause*

Resource users don't have access to the required Service Accounts.

*Solution*

*Rook Ceph Operator*

[source,bash]
----
oc -n rook-ceph get rs rook-ceph-operator-746677996c -oyaml | grep serviceAccount
----

[source,]
----
serviceAccount: rook-ceph-system
serviceAccountName: rook-ceph-system
----

[source,bash]
----
oc -n rook-ceph get rs rook-ceph-operator-746677996c  -oyaml | oc adm policy scc-subject-review  --filename -
----

[source,]
----
RESOURCE                                   ALLOWED BY   
ReplicaSet/rook-ceph-operator-746677996c   anyuid 
----

[source,bash]
----
oc adm policy add-scc-to-user anyuid -z rook-ceph-system

oc adm policy add-cluster-role-to-user cluster-admin system:serviceaccount:rook-ceph:rook-ceph-system
oc adm policy add-scc-to-user anyuid -z rook-ceph-system -n rook-ceph
oc adm policy add-scc-to-user privileged -z rook-ceph-system -n rook-ceph

oc adm policy add-cluster-role-to-user cluster-admin system:serviceaccount:rook-ceph:default
oc adm policy add-scc-to-user anyuid -z default -n rook-ceph
oc adm policy add-scc-to-user privileged -z default -n rook-ceph
----

Redeploy Operator.

[source,bash]
----
oc -n rook-ceph scale deployment rook-ceph-operator --replicas=0
oc -n openshift-storage scale deployment ocs-operator --replicas=0
oc -n rook-ceph scale deployment -l app=rook-ceph-mon --replicas=0
echo "Sleeping 5s..." ; sleep 5 ; echo "...wake up!"
oc -n rook-ceph scale deployment -l app=rook-ceph-mon --replicas=1
oc -n openshift-storage scale deployment ocs-operator --replicas=1
oc -n rook-ceph scale deployment rook-ceph-operator --replicas=1
----

*Rook Ceph Monitor*

[source,bash]
----
oc -n rook-ceph get rs rook-ceph-mon-c-64f848668b -oyaml | grep serviceAccount
----

[source,]
----
serviceAccount: rook-ceph-default
serviceAccountName: rook-ceph-default
----

[source,bash]
----
oc -n rook-ceph get rs rook-ceph-mon-c-64f848668b -oyaml | oc adm policy scc-subject-review  --filename -
----

[source,]
----
RESOURCE                                ALLOWED BY                     
ReplicaSet/rook-ceph-mon-c-64f848668b   db2u-c-mas-masovh-system-scc
----

[source,bash]
----
oc adm policy add-scc-to-user db2u-c-mas-masovh-system-scc -z rook-ceph-default
oc adm policy add-scc-to-user db2u-c-mas-masovh-system-scc -z rook-ceph-default -n rook-ceph
----

*Rook Ceph MDS*

[source,bash]
----
oc -n rook-ceph get rs rook-ceph-mgr-a-95f4697b9 -oyaml | grep serviceAccount
----

[source,]
----
serviceAccount: rook-ceph-mgr
serviceAccountName: rook-ceph-mgr
----

[source,bash]
----
oc -n rook-ceph get rs rook-ceph-mgr-a-95f4697b9 -oyaml | oc adm policy scc-subject-review  --filename -
----

[source,]
----
RESOURCE                                ALLOWED BY                     
ReplicaSet/rook-ceph-mgr-a-95f4697b9   db2u-c-mas-masovh-system-scc
----

[source,bash]
----
oc adm policy add-scc-to-user db2u-c-mas-masovh-system-scc -z rook-ceph-mgr
oc adm policy add-scc-to-user db2u-c-mas-masovh-system-scc -z rook-ceph-mgr -n rook-ceph
----

*Rook Ceph OSD*

[source,bash]
----
oc -n rook-ceph get rs rook-ceph-osd-1-c9c7f6b97 -oyaml | grep serviceAccount
----

[source,]
----
serviceAccount: rook-ceph-osd
serviceAccountName: rook-ceph-osd
----

[source,bash]
----
oc -n rook-ceph get rs rook-ceph-osd-1-c9c7f6b97 -oyaml | oc adm policy scc-subject-review  --filename -
----

[source,]
----
RESOURCE                                ALLOWED BY                     
ReplicaSet/rook-ceph-osd-1-c9c7f6b97   db2u-c-mas-masovh-system-scc
----

[source,bash]
----
oc adm policy add-scc-to-user db2u-c-mas-masovh-system-scc -z rook-ceph-osd
oc adm policy add-scc-to-user db2u-c-mas-masovh-system-scc -z rook-ceph-osd -n rook-ceph
----

*CSI CephFS plugin*

[source,bash]
----
oc -n rook-ceph get rs csi-cephfsplugin-provisioner-6668bdd9b -oyaml | grep serviceAccount
----

[source,]
----
serviceAccount: rook-csi-cephfs-provisioner-sa
serviceAccountName: rook-csi-cephfs-provisioner-sa
----

[source,bash]
----
oc -n rook-ceph get rs csi-cephfsplugin-provisioner-6668bdd9b -oyaml | oc adm policy scc-subject-review  --filename -
----

[source,]
----
RESOURCE                                ALLOWED BY                     
ReplicaSet/csi-cephfsplugin-provisioner-6668bdd9b   db2u-c-mas-masovh-system-scc
----

[source,bash]
----
oc adm policy add-scc-to-user db2u-c-mas-masovh-system-scc -z rook-csi-cephfs-provisioner-sa
oc adm policy add-scc-to-user db2u-c-mas-masovh-system-scc -z rook-csi-cephfs-provisioner-sa -n rook-ceph
----

This might take a while to recover from.

*CSI RBD Plugin*


[source,bash]
----
oc -n rook-ceph get rs csi-rbdplugin-provisioner-57b5f57b9 -oyaml | grep serviceAccount
----

[source,]
----
serviceAccount: rook-csi-rbd-provisioner-sa
serviceAccountName: rook-csi-rbd-provisioner-sa
----

[source,bash]
----
oc -n rook-ceph get rs csi-rbdplugin-provisioner-57b5f57b9 -oyaml | oc adm policy scc-subject-review  --filename -
----

[source,]
----
RESOURCE                                ALLOWED BY                     
ReplicaSet/csi-cephfsplugin-provisioner-6668bdd9b   db2u-c-mas-masovh-system-scc
----

[source,bash]
----
oc adm policy add-scc-to-user db2u-c-mas-masovh-system-scc -z rook-csi-rbd-provisioner-sa
oc adm policy add-scc-to-user db2u-c-mas-masovh-system-scc -z rook-csi-rbd-provisioner-sa -n rook-ceph
----

[NOTE]
====
Although it seems thi solution is not working, it ends up generating the POD 
 after a while.

Follow the POD and ReplicaSet state update using the following commands.

.POD state change
[source,bash]
----
oc -n rook-ceph get pod -w
----

.ReplicaSet state change
[source,bash]
----
oc -n rook-ceph get rs -w
----
====
