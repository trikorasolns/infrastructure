---
- name: "Generate OCP Cluster installation"
  hosts: "ocp_services"
  gather_facts: true

  pre_tasks:
  - name: "Validate required variables"
    ansible.builtin.assert:
      that:
      - "ocp_install_root_dir is defined and ocp_install_root_dir | length > 0"

  - name: "Set variables"
    ansible.builtin.set_fact:
      openshift_client_root_url: "https://mirror.openshift.com/pub/openshift-v4/{{ ocp_release_arch }}/clients/ocp/{{ ocp_version }}"


  tasks:
  - name: "Create openshift install root directory"
    ansible.builtin.file:
      path: "{{ ocp_install_root_dir }}"
      state: directory
      mode: '0755'

  - name: "Get release information"
    ansible.builtin.get_url:
      url: "{{ openshift_client_root_url }}/release.txt"
      dest: "{{ ocp_install_root_dir }}/"
      # mode: '0440'

  - name: "Get release image name"
    ansible.builtin.shell: |
      grep 'Pull From: quay.io' release.txt | awk -F ' ' '{print $3}'
    args:
      chdir: "{{ ocp_install_root_dir }}"
    register: image_name_res

  - name: "Download the ocp installer and client"
    ansible.builtin.get_url:
      url: "{{ openshift_client_root_url }}/{{ item }}"
      dest: "{{ ocp_install_root_dir }}/{{ item }}"
    loop:
      - openshift-install-linux.tar.gz
      - openshift-client-linux.tar.gz

  - name: "Extract the ocp installer and client"
    ansible.builtin.unarchive:
      src: "{{ ocp_install_root_dir }}/{{ item }}"
      dest: "{{ ocp_install_root_dir }}"
      remote_src: true
    loop:
      - openshift-install-linux.tar.gz
      - openshift-client-linux.tar.gz

  - name: "Print image name"
    ansible.builtin.debug:
      msg:
        - "image_name_res: {{ image_name_res.stdout }}"

...
