---
- name: "Fix Control Planes"
  hosts: "ocp_bootstrap,ocp_control_plane,ocp_compute_node"
  gather_facts: true

  tasks:
  - name: "Apply the patch config for CNI"
    ansible.builtin.copy:
      src: "10-containerd-net.conflist"
      dest: "/etc/kubernetes/cni/net.d/10-containerd-net.conflist"
      mode: '0644'
    become: true
    register: cni_apply_res

  - name: "Print result"
    ansible.builtin.debug:
      msg:
        - "register: cni_apply_res: {{ register: cni_apply_res }}"

  - name: "Restart the affected services. Only required if the cni configuration is applied prior to the node is restarted after applying the ignition."
    ansible.builtin.service:
      name: "{{ item }}"
      state: restarted
    loop: 
    - crio
    - kubelet
    become: true
    when: (cni_apply_res.changed and restart_services is defined and (restart_services | bool)) or (force_restart is defined and (force_restart | bool))
...
