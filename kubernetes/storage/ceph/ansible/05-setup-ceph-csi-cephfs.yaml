---
- name: "Setup ceph/csi-cephfs"
  hosts: "{{ k8s_host | default('localhost') }}"
  gather_facts: "{{ gathering_host_info | default('true') | bool == true }}"

  tasks:
  - name: Create a k8s namespace
    kubernetes.core.k8s:
      name: "{{ ceph_ns }}"
      api_version: v1
      kind: Namespace
      state: present

  - name: "Create k8s secret with Ceph Admin key"
    ansible.builtin.shell: |
      kubectl create secret generic csi-cephfs-secret \
        --from-literal=userID='{{ ceph_admin_id }}' \
        --from-literal=userKey='{{ ceph_admin_key }}' \
        --namespace={{ ceph_ns }}
    register: secret_create_res
    failed_when: secret_create_res.rc != 0 and 'already exists' not in secret_create_res.stderr

  - name: "Template ceph/csi-cephfs values file"
    ansible.builtin.template:
      src: "helm-ceph-csi-cephfs.yaml.j2"
      dest: "/tmp/helm-ceph-csi-cephfs.yaml"

  - name: "Deploy latest version of ceph-csi/ceph-csi-cephfs chart"
    kubernetes.core.helm:
      name: ceph-csi-cephfs
      chart_ref: ceph-csi/ceph-csi-cephfs
      release_namespace: "{{ ceph_ns }}"
      create_namespace: true
      values_files:
      - "/tmp/helm-ceph-csi-cephfs.yaml"

  - name: "Gather information of the status of the Chart"
    kubernetes.core.helm_info:
      name: ceph-csi-cephfs
      release_namespace: "{{ ceph_ns }}"
    register: ceph_csi_cephfs_status
    until: "ceph_csi_cephfs_status.status.status == 'deployed'"
    retries: 12
    delay: 5

  - name: "Print full Helm Chart deployment information"
    ansible.builtin.debug:
      var: ceph_csi_cephfs_status
      verbosity: 2

  - name: "Print Helm Chart deployment status"
    ansible.builtin.debug:
      msg: 
      - "helm deployment status: {{ ceph_csi_cephfs_status.status.status }}"

  - name: "Download test PVC definition (csi-cephfs-pvc)"
    ansible.builtin.get_url:
      url: https://raw.githubusercontent.com/ceph/ceph-csi/refs/heads/devel/examples/cephfs/pvc.yaml
      dest: /tmp/test_ceph_pvc.yaml
      mode: '0664'

  - name: "Create test PVC (csi-cephfs-pvc)"
    kubernetes.core.k8s:
      state: present
      namespace: "{{ ceph_ns }}"
      src: /tmp/test_ceph_pvc.yaml

  - name: "Get test PVC information (csi-cephfs-pvc) and wait to be Bound"
    kubernetes.core.k8s_info:
      api_version: v1
      kind: pvc
      name: csi-cephfs-pvc
      namespace: "{{ ceph_ns }}"
    register: csi_cephfs_pvc_status
    until: "csi_cephfs_pvc_status.resources[0].status.phase == 'Bound'"
    retries: 40
    delay: 3

  - name: "Print PVC information"
    ansible.builtin.debug:
      var: csi_cephfs_pvc_status.resources[0].status

  - name: "Download demo POD definition (csi-cephfs-demo-pod)"
    ansible.builtin.get_url:
      url: https://raw.githubusercontent.com/ceph/ceph-csi/refs/heads/devel/examples/cephfs/pod.yaml
      dest: /tmp/test_ceph_pod.yaml
      mode: '0664'

  - name: "Create demo POD (csi-cephfs-demo-pod)"
    kubernetes.core.k8s:
      state: present
      namespace: "{{ ceph_ns }}"
      src: /tmp/test_ceph_pod.yaml

  - name: "Get demo POD information (csi-cephfs-demo-pod) and wait to be Deployed"
    kubernetes.core.k8s_info:
      api_version: v1
      kind: Pod
      name: csi-cephfs-demo-pod
      namespace: "{{ ceph_ns }}"
    register: csi_cephfs_demo_pod_status
    until: "csi_cephfs_demo_pod_status.resources[0].status.phase == 'Running'"
    retries: 24
    delay: 5

  - name: "Print PVC information"
    ansible.builtin.debug:
      var: csi_cephfs_demo_pod_status.resources[0].status

  - name: "Delete demo POD (csi-cephfs-demo-pod)"
    kubernetes.core.k8s:
      state: absent
      namespace: "{{ ceph_ns }}"
      kind: Pod
      name: csi-cephfs-demo-pod

  - name: "Delete test PVC (csi-cephfs-pvc)"
    kubernetes.core.k8s:
      state: absent
      namespace: "{{ ceph_ns }}"
      kind: pvc
      name: csi-cephfs-pvc
...
