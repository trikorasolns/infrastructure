---
- name: "Test cephfs"
  hosts: "{{ k8s_host | default('localhost') }}"
  gather_facts: "{{ gathering_host_info | default('true') | bool == true }}"

  pre_tasks:

  tasks:

  - name: "Template cephfs test PVC"
    ansible.builtin.template:
      src: "test-cephfs-claim.yml.j2"
      dest: "/tmp/test-cephfs-claim.yml"

  - name: "Create test cephfs PVC"
    kubernetes.core.k8s:
      src: "/tmp/test-cephfs-claim.yml"
      state: present

  - name: "Check if PVC is bound"
    kubernetes.core.k8s_info:
      # api_version: v1
      kind: pvc
      name: cephfs-claim1
      namespace: "{{ ceph_ns }}"
    register: cephfs_claim1_res

  - name: "Check if PVC is bound"
    ansible.builtin.debug:
      var: cephfs_claim1_res
      verbosity: 2

  - name: "Build custom Pod information list"
    ansible.builtin.set_fact:
      cephfs_claim1_info: "{{ cephfs_claim1_res.resources | to_json | from_json }}"

  - name: "Check if PVC information"
    ansible.builtin.debug:
      msg: 
      - "cephfs_claim1_info: {{ cephfs_claim1_info }}"
      verbosity: 2

  - name: "Parse PVC information"
    ansible.builtin.set_fact:
      cephfs_claim1_json: "{{ cephfs_claim1_info[0] }}"

  - name: "Check if PVC information"
    ansible.builtin.debug:
      msg: 
      - "cephfs_claim1_json: {{ cephfs_claim1_json }}"
      - "cephfs_claim1_json.status: {{ cephfs_claim1_json.status }}"
      - "cephfs_claim1_json.status.phase: {{ cephfs_claim1_json.status.phase }}"

  - name: "Go to "
    ansible.builtin.assert:
      that:
      - cephfs_claim1_json.status.phase == 'Bound'
...
