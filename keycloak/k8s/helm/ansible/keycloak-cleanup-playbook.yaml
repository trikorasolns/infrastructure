---
- name: "Cleanup keycloak"
  hosts: "localhost"
  gather_facts: "{{ gathering_host_info | default('true') | bool == true }}"

  pre_tasks:

    - name: "Validate variables"
      assert:
        that:
          - "app_namespace is defined and (app_namespace | length > 0)"
        fail_msg: 
          - "app_namespace must be defined with the kubernetes namespace"

  tasks:

    - name: "Uninstall Keycloak chart"
      kubernetes.core.helm:
        name: "{{ app_name }}"
        release_namespace: "{{ app_namespace }}"
        state: absent
        wait: true
      register: keycloak_helm_res 

    - name: "Uninstall PostgreSQL chart"
      kubernetes.core.helm:
        name: "postgresql"
        release_namespace: "{{ app_namespace }}"
        state: absent
        wait: true
      register: keycloak_helm_res

    - name: "Remove keycloak namespace"
      kubernetes.core.k8s:
        name: "{{ app_namespace }}"
        api_version: v1
        kind: Namespace
        state: absent
...
